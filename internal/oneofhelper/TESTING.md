# protoc_gen_go_helpers Test Suite

This directory contains comprehensive tests for the protoc_gen_go_helpers plugin to ensure safe refactoring and prevent regressions.

## Test Categories

### 1. Unit Tests
**Files**: `simple_test.go`, `comprehensive_test.go`

- âœ… **Function-level testing** - Tests individual functions like `lowerFirst()`, `getFieldType()`, etc.
- âœ… **Mocked components** - Uses protogen mocks for isolated testing  
- âœ… **Edge cases** - Empty inputs, various field types, complex scenarios
- âœ… **Integration** - End-to-end workflow with real protobuf structures

### 2. Golden File Tests (EXHAUSTIVE)
**Files**: `exhaustive_golden_test.go`, `golden_test.go`, `file_integration_test.go`

- âœ… **Byte-for-byte comparison** - Detects ANY change in generated output
- âœ… **Real proto files** - Uses actual .proto files as input  
- âœ… **Real protoc execution** - Runs the actual protoc plugin process
- âœ… **Regression detection** - Catches even single character changes
- âœ… **Multiple scenarios** - Tests various proto patterns

## Test Data Structure

```
testdata/
â”œâ”€â”€ proto/                           # Input proto files
â”‚   â”œâ”€â”€ simple_oneof.proto          # Basic oneof scenarios  
â”‚   â”œâ”€â”€ complex_types.proto         # Multiple field types
â”‚   â”œâ”€â”€ nested_messages.proto       # Nested message structures
â”‚   â””â”€â”€ no_oneof.proto             # Messages without oneofs
â””â”€â”€ golden/                         # Expected output files  
    â”œâ”€â”€ simple_oneof_helpers.pb.go
    â”œâ”€â”€ complex_types_helpers.pb.go
    â”œâ”€â”€ nested_messages_helpers.pb.go
    â””â”€â”€ no_oneof_helpers.pb.go
```

## Running Tests

### All Tests
```bash
go test -v
```

### Specific Test Categories  
```bash
# Unit tests only
go test -v -run TestLowerFirst
go test -v -run TestMainFunctionalities

# Exhaustive golden file tests  
go test -v -run TestExhaustiveGoldenFiles

# Regression detection
go test -v -run TestExhaustiveRegression

# File validation
go test -v -run TestGoldenFileValidity
```

### Updating Golden Files
When you intentionally change the plugin output:

```bash
UPDATE_GOLDEN=1 go test -run TestExhaustiveGoldenFiles
```

## Test Coverage

### Proto File Scenarios Tested:

#### `simple_oneof.proto`
```proto
message SimpleMessage {
  message EmailAuth {
    string email = 1;
    string password = 2; 
  }
  message TokenAuth {
    string token = 1;
  }
  oneof auth_method {
    EmailAuth email = 1;
    TokenAuth token = 2;
  }
}
```

#### `complex_types.proto`  
- **Field types**: string, int32, bool, repeated, map, enum
- **Complex structures**: Multiple oneof options with varied parameters
- **Type conversion**: Tests all protobuf â†’ Go type mappings

#### `nested_messages.proto`
- **Nested oneofs**: Messages with oneofs inside other messages  
- **Recursive processing**: Tests deep message hierarchy handling

#### `no_oneof.proto`
- **Edge case**: Messages without any oneof fields
- **Minimal output**: Should generate only headers

### Generated Helper Examples:

**Simple Oneof Helper:**
```go
// NewSimpleMessageEmail creates a new SimpleMessage with Email set
func NewSimpleMessageEmail(email string, password string) *SimpleMessage {
    return &SimpleMessage{
        AuthMethod: &SimpleMessage_Email{
            Email: &SimpleMessage_EmailAuth{
                Email:    email,
                Password: password,
            },
        },
    }
}
```

**Complex Types Helper:**
```go  
// NewComplexMessageDatabase creates a new ComplexMessage with Database set
func NewComplexMessageDatabase(host string, port int32, databases []string, 
    options map[string]string, sslEnabled bool, status Status) *ComplexMessage {
    return &ComplexMessage{
        StorageConfig: &ComplexMessage_Database{
            Database: &ComplexMessage_DatabaseConfig{
                Host:       host,
                Port:       port, 
                Databases:  databases,
                Options:    options,
                SslEnabled: sslEnabled,
                Status:     status,
            },
        },
    }
}
```

## Regression Detection

The exhaustive tests catch ANY change to generated output:

- âœ… **Single character changes** (even punctuation) 
- âœ… **Whitespace differences** (spaces, tabs, newlines)
- âœ… **Function signature changes** (parameter names, types, order)
- âœ… **Comment format changes** (generation notices, function docs)
- âœ… **Package/import changes** (package names, import paths)
- âœ… **Struct initialization changes** (field assignments, nesting)

### Example Regression Detection:
```
Generated: "// Code generated by protoc_gen_go_helpers - DO NOT EDIT!"
Golden:    "// Code generated by protoc_gen_go_helpers. DO NOT EDIT." 
                                                       ^ single char diff detected
```

## Benefits for Refactoring

1. **Complete Confidence** - Any output change is immediately detected
2. **Fast Feedback** - Tests run in ~2 seconds, providing quick verification  
3. **Precise Debugging** - Exact byte location and line-by-line diffs
4. **Easy Updates** - Single command updates golden files when changes are intentional
5. **Multiple Verification** - Both unit tests and golden file tests provide overlapping coverage

## Test Performance

- **Unit Tests**: ~0.2s - Fast function-level verification
- **Golden File Tests**: ~1s - Comprehensive output verification  
- **Regression Tests**: ~1s - Cross-file consistency checking
- **Total Runtime**: ~2s - Complete test suite

Run with `go test -short` to skip longer regression tests during development.

## Maintenance

### Adding New Test Cases:
1. Add new `.proto` file to `testdata/proto/`
2. Generate golden file: `protoc --plugin=... --go-helpers_out=testdata/golden ...`
3. Tests automatically pick up new files via glob patterns

### Regenerating All Golden Files:
```bash
# Build plugin
go build -o protoc-gen-go-oneof-helper .

# Generate all golden files  
for proto in testdata/proto/*.proto; do
    protoc --plugin=protoc-gen-go-oneof-helper=./protoc-gen-go-oneof-helper \
           --go-helpers_out=testdata/golden \
           --proto_path=testdata/proto \
           "$proto"
done

# Move files to flat structure
mv testdata/golden/github.com/SebastienMelki/sebuf/internal/oneofhelper/testdata/* testdata/golden/
rm -rf testdata/golden/github.com

# Clean up
rm protoc-gen-go-oneof-helper
```

This test suite ensures that any refactoring of the plugin will maintain 100% output compatibility! ðŸŽ¯