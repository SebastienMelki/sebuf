//
//  FileGenerator.swift
//  buf-gen-swift
//
//  Created by Khaled Chehabeddine on 10/01/2026.
//  Copyright Â© 2026 Sebuf. All rights reserved.
//

import SwiftProtobufPluginLibrary

internal final class FileGenerator {
	
	private let descriptor: FileDescriptor
	private let options: GeneratorOptions
	
	internal init(descriptor: FileDescriptor, options: GeneratorOptions) {
		self.descriptor = descriptor
		self.options = options
	}
	
	internal var name: String {
		let baseName = descriptor.name.replacingOccurrences(of: ".proto", with: "")
		return "\(baseName).sebuf.swift"
	}
	
	internal func generate(printer p: inout CodePrinter) throws(GeneratorError) {
		guard descriptor.options.swiftPrefix.isEmpty
				|| isValidSwiftIdentifier(descriptor.options.swiftPrefix, allowQuoted: false) else {
			throw .invalidSwiftPrefix(filename: descriptor.name, prefix: descriptor.options.swiftPrefix)
		}
		p.print(
			"""
			// DO NOT EDIT.
			// swift-format-ignore-file
			// swiftlint:disable all
			//
			// Generated by the Sebuf generator plugin for the buf compiler.
			// Source: \(descriptor.name)
			//
			// For information on using the generated types, please see the documentation:
			//   https://github.com/SebastienMelki/sebuf/
			
			"""
		)
		p.print(
			"""
			import SwiftProtobuf
			
			"""
		)
		
		guard !descriptor.services.isEmpty else {
			p.print("// This file contained no services.")
			return
		}
		
		generateVersionCheck(printer: &p)
		
		let services = descriptor.services.map { descriptor in
			ServiceGenerator(descriptor: descriptor, options: options)
		}
		for service in services {
			service.generate(printer: &p)
		}
	}
	
	private func generateVersionCheck(printer p: inout CodePrinter) {
		let v = Version.compatibility
		p.print(
			"""
			// If the compiler emits an error on this type, it is because this file
			// was generated by a version of the `protoc` Swift plug-in that is
			// incompatible with the version of SwiftProtobuf to which you are linking.
			// Please ensure that you are building against the same version of the API
			// that was used to generate this file.
			fileprivate struct _GeneratedWithProtocGenSwiftVersion: SwiftProtobuf.ProtobufAPIVersionCheck {
			"""
		)
		p.printIndented(
			"""
			struct _\(v): SwiftProtobuf.ProtobufAPIVersion_\(v) {}
			typealias Version = _\(v)
			"""
		)
		p.print("}")
	}
}
