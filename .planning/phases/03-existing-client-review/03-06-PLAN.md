---
phase: 03-existing-client-review
plan: 06
type: execute
wave: 3
depends_on: ["03-03", "03-04", "03-05"]
files_modified:
  - internal/httpgen/testdata/golden/http_verbs_comprehensive_http.pb.go
  - internal/httpgen/testdata/golden/http_verbs_comprehensive_http_binding.pb.go
  - internal/httpgen/testdata/golden/http_verbs_comprehensive_http_config.pb.go
  - internal/clientgen/testdata/golden/http_verbs_comprehensive_client.pb.go
  - internal/tsclientgen/testdata/golden/http_verbs_comprehensive_client.ts
autonomous: true

must_haves:
  truths:
    - "All 4 generators produce semantically consistent output for every service in the shared exhaustive test proto"
    - "Golden file tests pass for all 4 generators simultaneously"
    - "For each RPC: server path matches client path matches OpenAPI path"
    - "For each RPC: server request schema matches client request serialization matches OpenAPI request schema"
    - "For each RPC: server response schema matches client response deserialization matches OpenAPI response schema"
    - "Error response format is consistent across all 4 generators"
    - "All existing tests pass (no regressions from Phase 3 fixes)"
  artifacts:
    - path: "internal/httpgen/testdata/golden/"
      provides: "Server golden files passing after all Phase 3 fixes"
    - path: "internal/clientgen/testdata/golden/"
      provides: "Go client golden files passing after all Phase 3 fixes"
    - path: "internal/tsclientgen/testdata/golden/"
      provides: "TS client golden files passing after all Phase 3 fixes"
    - path: "internal/openapiv3/testdata/golden/"
      provides: "OpenAPI golden files passing after all Phase 3 fixes"
  key_links:
    - from: "all 4 generators"
      to: "shared exhaustive test proto"
      via: "golden file tests"
      pattern: "http_verbs_comprehensive"
---

<objective>
Perform the final cross-generator consistency verification. Regenerate all golden files, run all tests, and verify that all 4 generators produce semantically consistent output for the shared test protos. This is the definitive validation that the Phase 3 audit and fixes have achieved full cross-generator consistency.

Purpose: Individual generator fixes (plans 02-05) may have introduced subtle changes that affect other generators. This final plan ensures everything is consistent end-to-end, with all tests passing simultaneously, and performs a manual semantic comparison of the key outputs.

Output: All 4 generators verified consistent, all tests passing, phase ready for verification.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-existing-client-review/03-CONTEXT.md
@.planning/phases/03-existing-client-review/03-RESEARCH.md
@.planning/phases/03-existing-client-review/03-01-SUMMARY.md
@.planning/phases/03-existing-client-review/03-02-SUMMARY.md
@.planning/phases/03-existing-client-review/03-03-SUMMARY.md
@.planning/phases/03-existing-client-review/03-04-SUMMARY.md
@.planning/phases/03-existing-client-review/03-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild all binaries and regenerate all golden files from scratch</name>
  <files>
internal/httpgen/testdata/golden/
internal/clientgen/testdata/golden/
internal/tsclientgen/testdata/golden/
internal/openapiv3/testdata/golden/
  </files>
  <action>
Perform a clean rebuild and regeneration to ensure everything is consistent:

1. **Build all plugin binaries from scratch:**
   ```
   make build
   ```

2. **Regenerate ALL golden files for ALL generators:**
   ```
   UPDATE_GOLDEN=1 go test ./internal/httpgen/ -run TestExhaustiveGoldenFiles -count=1
   UPDATE_GOLDEN=1 go test ./internal/clientgen/ -count=1
   UPDATE_GOLDEN=1 go test ./internal/tsclientgen/ -count=1
   UPDATE_GOLDEN=1 go test ./internal/openapiv3/ -count=1
   ```

3. **Run ALL tests without UPDATE_GOLDEN to verify they pass:**
   ```
   go test ./internal/httpgen/ -count=1
   go test ./internal/clientgen/ -count=1
   go test ./internal/tsclientgen/ -count=1
   go test ./internal/openapiv3/ -count=1
   ```

4. **Run the full test suite:**
   ```
   ./scripts/run_tests.sh
   ```

If any test fails, diagnose and fix the issue. The fix should be minimal -- most issues at this stage are integration issues between the per-generator fixes from plans 02-05.

Run `make lint-fix` after any fixes.
  </action>
  <verify>
`./scripts/run_tests.sh` passes with all tests green. `make build` succeeds. `make lint-fix` produces no changes.
  </verify>
  <done>All 4 generators build, all golden files are current, and all tests pass simultaneously.</done>
</task>

<task type="auto">
  <name>Task 2: Cross-generator semantic comparison for the shared exhaustive test proto</name>
  <files>None (read-only comparison task; may modify files if issues found)</files>
  <action>
Perform a manual semantic comparison across all 4 generators for the `http_verbs_comprehensive.proto` shared test proto. For each service in the proto, compare:

**For RESTfulAPIService:**

1. **Path consistency**: Read the generated server routing config, Go client URL construction, TS client URL construction, and OpenAPI paths. Verify they all produce the same paths for each RPC:
   - ListResources: `/api/v1/resources`
   - GetResource: `/api/v1/resources/{resource_id}`
   - GetNestedResource: `/api/v1/orgs/{org_id}/teams/{team_id}/resources/{resource_id}`
   - CreateResource: `/api/v1/resources`
   - UpdateResource: `/api/v1/resources/{resource_id}`
   - PatchResource: `/api/v1/resources/{resource_id}`
   - DeleteResource: `/api/v1/resources/{resource_id}`
   - SearchResources: `/api/v1/resources/search` (new from plan 01)

2. **HTTP method consistency**: Verify all 4 generators agree on the HTTP method for each RPC.

3. **Query parameter consistency**: For ListResources and SearchResources, verify:
   - Same parameter names across all 4 generators
   - Same types (especially int64/uint64 as string in OpenAPI)
   - Same required/optional semantics

4. **Request body schema consistency**: For CreateResource, UpdateResource, PatchResource:
   - Verify field names match (protojson camelCase)
   - Verify field types match (especially maps, nested messages, enums)
   - Verify the Go client sends what the server expects
   - Verify the TS client sends what the server expects
   - Verify OpenAPI documents what the server accepts

5. **Response body schema consistency**: For all RPCs returning Resource:
   - Verify field names match across all 4 generators
   - Verify int64 fields (created_at, updated_at) are handled correctly (string in JSON per protojson)
   - Verify enum fields (status) are string names
   - Verify nested message fields (metadata_detail) are present

6. **Error response consistency**:
   - Verify all generators agree on 400 = ValidationError, default = Error
   - Verify error schema fields match

7. **Header consistency**:
   - Verify service header X-API-Key appears in all generators
   - Verify method header X-Request-ID appears for CreateResource in all generators

**For BackwardCompatService:**
- Verify default paths are consistent across all 4 generators
- Verify default HTTP method (POST) is used

If any inconsistency is found during comparison, fix it. Document what was found and fixed. If everything is consistent, document the verification.

**Unwrap verification** (from unwrap.proto):
- Verify all unwrap variants produce consistent schemas/types across all 4 generators
- Map-value unwrap: server JSON `{"bars": {"AAPL": [...]}}` matches client expectations
- Root repeated unwrap: server JSON `[{...}, {...}]` matches client expectations
- Root map unwrap: server JSON `{"key": {...}}` matches client expectations
- Combined unwrap: server JSON `{"AAPL": [...]}` matches client expectations
  </action>
  <verify>
All tests still pass: `./scripts/run_tests.sh`. If any fixes were made, golden files were updated. The cross-generator comparison confirms semantic consistency for all RPCs in the shared test proto.
  </verify>
  <done>
Cross-generator semantic comparison complete. All 4 generators produce semantically consistent output for every RPC in the shared exhaustive test proto:
- Paths match across server, Go client, TS client, OpenAPI
- HTTP methods match
- Query/path parameters match (names, types, required/optional)
- Request/response body schemas match (field names, types, protojson conventions)
- Error responses match (ValidationError, Error)
- Headers match
- Unwrap variants are consistent
- Backward compat defaults are consistent
  </done>
</task>

</tasks>

<verification>
1. `./scripts/run_tests.sh` passes (all generators, all tests)
2. `make build` succeeds
3. `make lint-fix` produces no changes
4. Cross-generator comparison documented with no remaining inconsistencies
5. Phase 3 success criteria from ROADMAP.md are all met:
   - SC1: Go client serialization matches server (verified via golden files + comparison)
   - SC2: TS client JSON matches server (verified via golden files + comparison)
   - SC3: Error handling consistent (ValidationError + ApiError)
   - SC4: Header handling consistent (service + method headers)
   - SC5: All golden file tests pass, new test cases added
</verification>

<success_criteria>
- ALL tests pass across all 4 generators simultaneously
- Cross-generator semantic comparison confirms consistency for every RPC in the shared test proto
- No remaining known inconsistencies between any pair of generators
- Phase 3 success criteria 1-5 from ROADMAP.md are all satisfied
- The codebase is ready for Phase 4 (new annotation features)
</success_criteria>

<output>
After completion, create `.planning/phases/03-existing-client-review/03-06-SUMMARY.md`
</output>
